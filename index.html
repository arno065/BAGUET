<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAGUET FINGER - Localisateur de Distributeurs de Baguettes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #BA9B61;
        }
        #app {
            display: flex;
            height: 100%;
        }
        #sidebar {
            width: 300px;
            background-color: #F5DEB3;
            padding: 20px;
            overflow-y: auto;
        }
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #map {
            height: 60%;
            width: 100%;
        }
        #list {
            height: 40%;
            overflow-y: auto;
            padding: 10px;
            background-color: #FFF8E7;
        }
        .distributor-item, .sidebar-section {
            background-color: #FFEFD5;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #D2691E;
        }
        .stars {
            color: #FFD700;
        }
        #contextMenu {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            padding: 5px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        #contextMenu button {
            display: block;
            width: 100%;
            padding: 5px;
            margin: 2px 0;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
        }
        #contextMenu button:hover {
            background-color: #f0f0f0;
        }
        .favorite {
            color: gold;
            cursor: pointer;
        }
        #language-select {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="sidebar">
            <h2>Préférences</h2>
            <div class="sidebar-section">
                <label for="language-select">Langue :</label>
                <select id="language-select">
                    <option value="fr">Français</option>
                    <option value="en">English</option>
                </select>
            </div>
            <div class="sidebar-section">
                <h3>Favoris</h3>
                <ul id="favorites-list"></ul>
            </div>
            <div class="sidebar-section">
                <h3>Historique de recherche</h3>
                <ul id="search-history"></ul>
            </div>
            <div class="sidebar-section">
                <h3>Points de fidélité</h3>
                <p>Vos points : <span id="loyalty-points">0</span></p>
            </div>
        </div>
        <div id="main-content">
            <div id="map"></div>
            <div id="list"></div>
        </div>
    </div>
    <div id="contextMenu">
        <button id="centerMapBtn">Centrer la carte ici</button>
        <button id="addDistributorBtn">Ajouter un distributeur ici</button>
        <button id="findNearestBtn">Trouver le distributeur le plus proche</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Données statiques des distributeurs
        const distributors = [
            { id: 1, name: "Distributeur Boulangerie Paul", lat: 48.8584, lng: 2.2945, address: "123 Rue de Paris", price: 1.20, rating: 4, payment: ["cash", "card"], reviews: [] },
            { id: 2, name: "Distri-Baguette Express", lat: 48.8738, lng: 2.2950, address: "45 Avenue des Champs-Élysées", price: 1.10, rating: 3, payment: ["cash"], reviews: [] },
            { id: 3, name: "Le Petit Boulanger Automatique", lat: 48.8600, lng: 2.3400, address: "78 Boulevard Saint-Michel", price: 1.30, rating: 5, payment: ["card"], reviews: [] },
        ];

        let favorites = [];
        let searchHistory = [];
        let loyaltyPoints = 0;
        let currentLanguage = 'fr';

        const translations = {
            fr: {
                addReview: "Ajouter un avis",
                seeReviews: "Voir les avis",
                favorite: "Favori",
                viewOnMap: "Voir sur la carte",
                nearestDistributor: "Le distributeur le plus proche est",
                meters: "mètres",
                invalidInput: "Entrée invalide. Veuillez réessayer.",
                loyaltyPoints: "Points de fidélité",
                language: "Langue",
                favorites: "Favoris",
                searchHistory: "Historique de recherche"
            },
            en: {
                addReview: "Add review",
                seeReviews: "See reviews",
                favorite: "Favorite",
                viewOnMap: "View on map",
                nearestDistributor: "The nearest distributor is",
                meters: "meters",
                invalidInput: "Invalid input. Please try again.",
                loyaltyPoints: "Loyalty points",
                language: "Language",
                favorites: "Favorites",
                searchHistory: "Search history"
            }
        };

        // Initialisation de la carte
        const map = L.map('map').setView([48.8566, 2.3522], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        function translate(key) {
            return translations[currentLanguage][key] || key;
        }

        // Fonction pour ajouter un marqueur
        function addMarker(distributor) {
            const marker = L.marker([distributor.lat, distributor.lng]).addTo(map);
            marker.bindPopup(`
                <b>${distributor.name}</b><br>
                ${distributor.address}<br>
                Prix : ${distributor.price.toFixed(2)}€<br>
                Note : ${getStars(distributor.rating)}<br>
                Paiement : ${getPaymentIcons(distributor.payment)}<br>
                <button onclick="addReview(${distributor.id})">${translate('addReview')}</button>
                <button onclick="seeReviews(${distributor.id})">${translate('seeReviews')}</button>
            `);
        }

        // Fonction pour afficher les étoiles de notation
        function getStars(rating) {
            return '<span class="stars">' + '★'.repeat(rating) + '☆'.repeat(5-rating) + '</span>';
        }

        // Fonction pour afficher les icônes de paiement
        function getPaymentIcons(payment) {
            const icons = {
                cash: '<i class="fas fa-money-bill-alt" title="Espèces"></i>',
                card: '<i class="fas fa-credit-card" title="Carte"></i>'
            };
            return payment.map(p => icons[p]).join(' ');
        }

        // Fonction pour afficher la liste des distributeurs
        function displayList() {
            const listElement = document.getElementById('list');
            listElement.innerHTML = ''; // Clear existing list
            distributors.forEach(distributor => {
                const item = document.createElement('div');
                item.className = 'distributor-item';
                item.innerHTML = `
                    <h3>${distributor.name} 
                        <i class="fas fa-star favorite" onclick="toggleFavorite(${distributor.id})" 
                           style="color: ${favorites.includes(distributor.id) ? 'gold' : 'grey'}"></i>
                    </h3>
                    <p>${distributor.address}</p>
                    <p>Prix : ${distributor.price.toFixed(2)}€</p>
                    <p>Note : ${getStars(distributor.rating)}</p>
                    <p>Paiement : ${getPaymentIcons(distributor.payment)}</p>
                    <button onclick="centerMap(${distributor.lat}, ${distributor.lng})">${translate('viewOnMap')}</button>
                    <button onclick="addReview(${distributor.id})">${translate('addReview')}</button>
                    <button onclick="seeReviews(${distributor.id})">${translate('seeReviews')}</button>
                `;
                listElement.appendChild(item);
            });
        }

        // Fonction pour centrer la carte sur un distributeur
        function centerMap(lat, lng) {
            map.setView([lat, lng], 16);
        }

        // Gestion du menu contextuel
        let contextMenuLatLng;

        map.on('contextmenu', function(e) {
            contextMenuLatLng = e.latlng;
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.originalEvent.pageX + 'px';
            contextMenu.style.top = e.originalEvent.pageY + 'px';
        });

        document.getElementById('centerMapBtn').addEventListener('click', function() {
            map.setView(contextMenuLatLng, map.getZoom());
            hideContextMenu();
        });

        document.getElementById('addDistributorBtn').addEventListener('click', function() {
            const name = prompt("Nom du nouveau distributeur :");
            const address = prompt("Adresse du nouveau distributeur :");
            const price = parseFloat(prompt("Prix de la baguette :"));
            const rating = parseInt(prompt("Note (de 1 à 5) :"));
            const paymentMethods = prompt("Méthodes de paiement (cash, card ou les deux séparés par une virgule) :").split(',').map(m => m.trim());
            
            if (name && address && !isNaN(price) && !isNaN(rating) && paymentMethods.length > 0) {
                const newDistributor = {
                    id: distributors.length + 1,
                    name: name,
                    lat: contextMenuLatLng.lat,
                    lng: contextMenuLatLng.lng,
                    address: address,
                    price: price,
                    rating: rating,
                    payment: paymentMethods,
                    reviews: []
                };
                distributors.push(newDistributor);
                addMarker(newDistributor);
                displayList();
            } else {
                alert(translate('invalidInput'));
            }
            hideContextMenu();
        });

        document.getElementById('findNearestBtn').addEventListener('click', function() {
            let nearest = null;
            let minDistance = Infinity;
            distributors.forEach(distributor => {
                const distance = map.distance(contextMenuLatLng, [distributor.lat, distributor.lng]);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = distributor;
                }
            });
            if (nearest) {
                alert(`${translate('nearestDistributor')} "${nearest.name}" à ${Math.round(minDistance)} ${translate('meters')}.`);
                centerMap(nearest.lat, nearest.lng);
                addToSearchHistory(nearest.name);
            }
            hideContextMenu();
        });

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
        }

        // Fermer le menu contextuel en cliquant ailleurs sur la carte
        map.on('click', hideContextMenu);

        function toggleFavorite(id) {
            const index = favorites.indexOf(id);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(id);
                loyaltyPoints += 10;
                updateLoyaltyPoints();
            }
            displayList();
            updateFavoritesList();
        }

        function updateFavoritesList() {
            const favoritesList = document.getElementById('favorites-list');
            favoritesList.innerHTML = '';
            favorites.forEach(id => {
                const distributor = distributors.find(d => d.id === id);
                if (distributor) {
                    const li = document.createElement('li');
                    li.textContent = distributor.name;
                    favoritesList.appendChild(li);
                }
            });
        }

        function addToSearchHistory(name) {
            searchHistory.unshift(name);
            if (searchHistory.length > 5) {
                searchHistory.pop();
            }
            updateSearchHistory();
        }

        function updateSearchHistory() {
            const historyList = document.getElementById('search-history');
            historyList.innerHTML = '';
            searchHistory.forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                historyList.appendChild(li);
            });
        }

        function updateLoyaltyPoints() {
            document.getElementById('loyalty-points').textContent = loyaltyPoints;
        }

        function addReview(id) {
            const review = prompt("Ajoutez votre avis :");
            if (review) {
                const distributor = distributors.find(d => d.id === id);
                distributor.reviews.push(review);
                loyaltyPoints += 5;
                updateLoyaltyPoints();
            }
        }

        function seeReviews(id) {
            const distributor = distributors.find(d => d.id === id);
            if (distributor.reviews.length > 0) {
                alert(distributor.reviews.join('\n\n'));
            } else {
                alert("Aucun avis pour le moment.");
            }
        }

        document.getElementById('language-select').addEventListener('change', function(e) {
            currentLanguage = e.target.value;
            updateLanguage();
        });

        function updateLanguage() {
            document.querySelector('label[for="language-select"]').textContent = translate('language') + ' :';
            document.querySelector('.sidebar-section h3:nth-of-type(1)').textContent = translate('favorites');
            document.querySelector('.sidebar-section h3:nth-of-type(2)').textContent = translate('searchHistory');
            document.querySelector('.sidebar-section h3:nth-of-type(3)').textContent = translate('loyaltyPoints');
            document.getElementById('centerMapBtn').textContent = translate('centerMapBtn');
            document.getElementById('addDistributorBtn').textContent = translate('addDistributorBtn');
            document.getElementById('findNearestBtn').textContent = translate('findNearestBtn');
            displayList();
            updateFavoritesList();
            updateSearchHistory();
        }

        // Initialisation
        function init() {
            distributors.forEach(addMarker);
            displayList();
            updateFavoritesList();
            updateSearchHistory();
            updateLoyaltyPoints();
            updateLanguage();
        }

        init();
    </script>
</body>
</html>
